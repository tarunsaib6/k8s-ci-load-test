name: CI Load Test

on:
  pull_request:
    branches:
      - main

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up KinD cluster
        uses: helm/kind-action@v1.4.0
        with:
          version: "v0.20.0"
          config: kindCluster.yaml

      # deploy ingress controller to kind k8s cluster        
      - name: Install Ingress Controller
        run: |
          kubectl describe nodes
          kubectl apply -f nginxIngress.yaml        
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=90s

      # deploy http echos, service, configure ingress
      - name: Deploy http-echo applications
        run: |
          kubectl apply -f deployment-foo-bar.yaml
          sleep 5

          echo "##################################"
          echo "curl foo"
          curl localhost/foo

          echo "curl bar"
          curl localhost/bar

      - name: Install k6 for load testing
              run: |
                sudo apt-get install -y k6

      - name: Run k6 Performance Test
        id: k6-test
        run: |
          k6 run loadtest.js > test-results/k6-output.txt || true
          cat test-results/k6-output.txt


