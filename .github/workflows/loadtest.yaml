name: CI Load Test

on:
  pull_request:
    branches:
      - main

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up KinD cluster
        uses: helm/kind-action@v1.4.0
        with:
          version: "v0.20.0"
          config: kindCluster.yaml

      # deploy ingress controller to kind k8s cluster        
      - name: Install Ingress Controller
        run: |
          
          kubectl apply -f nginxIngress.yaml        
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=90s
          kubectl get svc -n ingress-nginx  
          echo "##########################################################"
          kubectl get svc ingress-nginx-controller -n ingress-nginx -o yaml

      # deploy http echos, service, configure ingress
      - name: Deploy http-echo applications
        run: |
          kubectl apply -f deployment-foo-bar.yaml
          sleep 5
          kubectl get pods 
          kubectl get service
          kubectl get ingress
          echo "##################################"
          
          curl localhost/foo
          curl localhost/bar


      # # configure ingress
      # - name: Configure Ingress
      #   run: |
      #     cat <<EOF | kubectl apply -f -
      #     apiVersion: networking.k8s.io/v1
      #     kind: Ingress
      #     metadata:
      #       name: http-echo-ingress
      #       namespace: default
      #     spec:
      #       rules:
      #         - host: foo.localhost
      #           http:
      #             paths:
      #               - path: /
      #                 pathType: Prefix
      #                 backend:
      #                   service:
      #                     name: foo
      #                     port:
      #                       number: 5678
      #         - host: bar.localhost
      #           http:
      #             paths:
      #               - path: /
      #                 pathType: Prefix
      #                 backend:
      #                   service:
      #                     name: bar
      #                     port:
      #                       number: 5679
      #     EOF
          



